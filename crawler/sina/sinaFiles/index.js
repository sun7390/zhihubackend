const hrefs = ["/102803_ctg1_4188_-_ctg1_4188?from=faxian_hot&mod=fenlei#", "/102803_ctg1_6288_-_ctg1_6288?from=faxian_hot&mod=fenlei#", "/102803_ctg1_2088_-_ctg1_2088?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5988_-_ctg1_5988?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5088_-_ctg1_5088?from=faxian_hot&mod=fenlei#", "/102803_ctg1_6388_-_ctg1_6388?from=faxian_hot&mod=fenlei#", "/102803_ctg1_1288_-_ctg1_1288?from=faxian_hot&mod=fenlei#", "/102803_ctg1_4288_-_ctg1_4288?from=faxian_hot&mod=fenlei#", "/102803_ctg1_4688_-_ctg1_4688?from=faxian_hot&mod=fenlei#", "/102803_ctg1_2488_-_ctg1_2488?from=faxian_hot&mod=fenlei#", "/102803_ctg1_3288_-_ctg1_3288?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5288_-_ctg1_5288?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5188_-_ctg1_5188?from=faxian_hot&mod=fenlei#", "/102803_ctg1_1388_-_ctg1_1388?from=faxian_hot&mod=fenlei#", "/102803_ctg1_4788_-_ctg1_4788?from=faxian_hot&mod=fenlei#", "/102803_ctg1_2188_-_ctg1_2188?from=faxian_hot&mod=fenlei#", "/102803_ctg1_6488_-_ctg1_6488?from=faxian_hot&mod=fenlei#", "/102803_ctg1_6588_-_ctg1_6588?from=faxian_hot&mod=fenlei#", "/102803_ctg1_6688_-_ctg1_6688?from=faxian_hot&mod=fenlei#", "/102803_ctg1_6788_-_ctg1_6788?from=faxian_hot&mod=fenlei#", "/102803_ctg1_2288_-_ctg1_2288?from=faxian_hot&mod=fenlei#", "/102803_ctg1_4988_-_ctg1_4988?from=faxian_hot&mod=fenlei#", "/102803_ctg1_1988_-_ctg1_1988?from=faxian_hot&mod=fenlei#", "/102803_ctg1_4388_-_ctg1_4388?from=faxian_hot&mod=fenlei#", "/102803_ctg1_6988_-_ctg1_6988?from=faxian_hot&mod=fenlei#", "/102803_ctg1_7088_-_ctg1_7088?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5788_-_ctg1_5788?from=faxian_hot&mod=fenlei#", "/102803_ctg1_4888_-_ctg1_4888?from=faxian_hot&mod=fenlei#", "/102803_ctg1_2588_-_ctg1_2588?from=faxian_hot&mod=fenlei#", "/102803_ctg1_3188_-_ctg1_3188?from=faxian_hot&mod=fenlei#", "/102803_ctg1_1488_-_ctg1_1488?from=faxian_hot&mod=fenlei#", "/102803_ctg1_2688_-_ctg1_2688?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5588_-_ctg1_5588?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5888_-_ctg1_5888?from=faxian_hot&mod=fenlei#", "/102803_ctg1_1688_-_ctg1_1688?from=faxian_hot&mod=fenlei#", "/102803_ctg1_4588_-_ctg1_4588?from=faxian_hot&mod=fenlei#", "/102803_ctg1_7188_-_ctg1_7188?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5388_-_ctg1_5388?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5488_-_ctg1_5488?from=faxian_hot&mod=fenlei#", "/102803_ctg1_4488_-_ctg1_4488?from=faxian_hot&mod=fenlei#", "/102803_ctg1_1588_-_ctg1_1588?from=faxian_hot&mod=fenlei#", "/102803_ctg1_2388_-_ctg1_2388?from=faxian_hot&mod=fenlei#", "/102803_ctg1_5688_-_ctg1_5688?from=faxian_hot&mod=fenlei#", "/102803_ctg1_2788_-_ctg1_2788?from=faxian_hot&mod=fenlei#", "/102803_ctg1_1788_-_ctg1_1788?from=faxian_hot&mod=fenlei#", "/102803_ctg1_7388_-_ctg1_7388?from=faxian_hot&mod=fenlei#", "/102803_ctg1_8788_-_ctg1_8788?from=faxian_hot&mod=fenlei#", "/102803_ctg1_8189_-_ctg1_8189?from=faxian_hot&mod=fenlei#"];

const names = ["社会", "国际", "科技", "科普", "数码", "财经", "股市", "明星", "综艺", "电视剧", "电影", "音乐", "汽车", "体育", "运动健身", "健康", "瘦身", "养生", "军事", "历史", "美女模特", "摄影", "情感", "搞笑", "辟谣", "正能量", "政务", "游戏", "旅游", "育儿", "校园", "美食", "房产", "家居", "星座", "读书", "三农", "设计", "艺术", "时尚", "美妆", "动漫", "宗教", "萌宠", "婚庆", "法律", "舞蹈", "收藏"]
// const names = ["Society", "International", "Technology", "Science", "Digital", "Finance", "Stock Market", "Stars", "Variety", "TV Dramas", "Movies", "Music", "Cars", "Sports", "Sports Fitness", "Health", "Slimming", "Health Care", "Military", "History", "Beauty Model", "Photography", "Emotion", "Funny", "Rumor ", "Positive Energy", "Government", "Games", "Tourism", "Parenting", "Campus", "Food", "Real Estate", "Home Furnishing", "Constellation", "Reading", "Sannong", "Design", "Art", "Fashion", "Beauty", "Animation", "Religion", "Cute Pet", "Wedding", "Law", "Dance", "Collection"]

const cookie = [
    {
        "domain": ".weibo.com",
        "hostOnly": false,
        "httpOnly": false,
        "name": "_s_tentry",
        "path": "/",
        "sameSite": "unspecified",
        "secure": false,
        "session": true,
        "storeId": "0",
        "value": "login.sina.com.cn",
        "id": 1
    },
    {
        "domain": ".weibo.com",
        "expirationDate": 1640604434.632994,
        "hostOnly": false,
        "httpOnly": false,
        "name": "ALF",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": "0",
        "value": "1640604434",
        "id": 2
    },
    {
        "domain": ".weibo.com",
        "hostOnly": false,
        "httpOnly": false,
        "name": "Apache",
        "path": "/",
        "sameSite": "unspecified",
        "secure": false,
        "session": true,
        "storeId": "0",
        "value": "3094546593157.77.1609068445255",
        "id": 3
    },
    {
        "domain": ".weibo.com",
        "expirationDate": 1669970325,
        "hostOnly": false,
        "httpOnly": false,
        "name": "NTKF_T2D_CLIENTID",
        "path": "/",
        "sameSite": "unspecified",
        "secure": false,
        "session": false,
        "storeId": "0",
        "value": "guestD2194769-84EF-254C-3777-229A43FD8A5C",
        "id": 4
    },
    {
        "domain": ".weibo.com",
        "expirationDate": 1924428437.632264,
        "hostOnly": false,
        "httpOnly": true,
        "name": "SCF",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": "0",
        "value": "Avc4UUxZIa-BrCud-OGVAXXGjRTjPiEOFzq0Lko0SlY8FYXYfuGCRqCihrkwHG2ZsnZ1QPiTPp5wif9kkVXlDxs.",
        "id": 5
    },
    {
        "domain": ".weibo.com",
        "expirationDate": 1919997397,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SINAGLOBAL",
        "path": "/",
        "sameSite": "unspecified",
        "secure": false,
        "session": false,
        "storeId": "0",
        "value": "2934184934329.9.1604637397541",
        "id": 6
    },
    {
        "domain": ".weibo.com",
        "hostOnly": false,
        "httpOnly": false,
        "name": "SSOLoginState",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": "0",
        "value": "1609068435",
        "id": 7
    },
    {
        "domain": ".weibo.com",
        "hostOnly": false,
        "httpOnly": true,
        "name": "SUB",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": true,
        "storeId": "0",
        "value": "_2A25y7B_GDeRhGeNK7loT8yzMzziIHXVRmHYOrDV8PUNbmtANLRHYkW9NSTuviHHBR3rE4UEbE_projXVoFc2_mvU",
        "id": 8
    },
    {
        "domain": ".weibo.com",
        "expirationDate": 1640604438.632626,
        "hostOnly": false,
        "httpOnly": false,
        "name": "SUBP",
        "path": "/",
        "sameSite": "no_restriction",
        "secure": true,
        "session": false,
        "storeId": "0",
        "value": "0033WrSXqPxfM725Ws9jqgMF55529P9D9Whduy0DzFpqD35hZkbuuNkv5JpX5KMhUgL.Fo-XSKnEe0z7ShB2dJLoIcQLxK-LBK-LBKzLxKBLB.-L1hnLxK-L1KeL1h2LxK-L12-L1-qLxK-L12BL1K-LxK-L12eL1h-LxK-L12eL1h-LxK.LBK-LBo5LxK-L1KeL1h2LxKqL1h.L12zLxKnLBK2LBKyRqcj7S05N",
        "id": 9
    },
    {
        "domain": ".weibo.com",
        "expirationDate": 1640172445,
        "hostOnly": false,
        "httpOnly": false,
        "name": "ULV",
        "path": "/",
        "sameSite": "unspecified",
        "secure": false,
        "session": false,
        "storeId": "0",
        "value": "1609068445293:9:7:2:3094546593157.77.1609068445255:1609042188101",
        "id": 10
    },
    {
        "domain": ".weibo.com",
        "expirationDate": 1640604445,
        "hostOnly": false,
        "httpOnly": false,
        "name": "UOR",
        "path": "/",
        "sameSite": "unspecified",
        "secure": false,
        "session": false,
        "storeId": "0",
        "value": ",,login.sina.com.cn",
        "id": 11
    },
    {
        "domain": ".weibo.com",
        "expirationDate": 1609154905,
        "hostOnly": false,
        "httpOnly": false,
        "name": "webim_unReadCount",
        "path": "/",
        "sameSite": "unspecified",
        "secure": false,
        "session": false,
        "storeId": "0",
        "value": "%7B%22time%22%3A1609068505620%2C%22dm_pub_total%22%3A162%2C%22chat_group_client%22%3A0%2C%22chat_group_notice%22%3A0%2C%22allcountNum%22%3A162%2C%22msgbox%22%3A0%7D",
        "id": 12
    },
    {
        "domain": ".weibo.com",
        "expirationDate": 1609142085.867052,
        "hostOnly": false,
        "httpOnly": false,
        "name": "wvr",
        "path": "/",
        "sameSite": "unspecified",
        "secure": false,
        "session": false,
        "storeId": "0",
        "value": "6",
        "id": 13
    },
    {
        "domain": "weibo.com",
        "expirationDate": 1609084668,
        "hostOnly": true,
        "httpOnly": false,
        "name": "wb_view_log_5458232044",
        "path": "/",
        "sameSite": "unspecified",
        "secure": false,
        "session": false,
        "storeId": "0",
        "value": "1707*9601.5",
        "id": 14
    }
    ]

const log4js = require('log4js');const puppeteer = require('puppeteer');
const logger = log4js.getLogger("weibo");
const fs = require('fs')
logger.level = 'debug';
const isNotUndef = (content) => Object.prototype.toString.call(content) !== "[object Undefined]";
const sleep = (delay) => {
    return new Promise(resolve => setTimeout(resolve, delay));
}

function getStat(path){
    return new Promise((resolve, reject) => {
        fs.stat(path, (err, stats) => {
            if(err){
                resolve(false);
            }else{
                resolve(stats);
            }
        })
    })
}
 
/**
 * 创建路径
 * @param {string} dir 路径
 */
function mkdir(dir){
    return new Promise((resolve, reject) => {
        fs.mkdir(dir, err => {
            if(err){
                resolve(false);
            }else{
                resolve(true);
            }
        })
    })
}

async function dirExists(dir){
    let isExists = await getStat(dir);
    //如果该路径且不是文件，返回true
    if(isExists && isExists.isDirectory()){
        return true;
    }else if(isExists){     //如果该路径存在但是文件，返回false
        return false;
    }
    let mkdirStatus = await mkdir(dir);;
    return mkdirStatus;
}

for (const name of names) {
    if (dirExists(name)) {
        logger.info(`${name} was created!`);
    }
}


(async function() {
    const createNewPage = async(url) => {
        const page = await browser.newPage();
        await page.setCookie(...cookie);
        await page.goto(url);
        await page
            .mainFrame()
            .addScriptTag({
                url: 'https://cdn.bootcss.com/jquery/3.2.0/jquery.min.js'
            })
        return page;
    };


    const browser = await puppeteer.launch({ headless: false });
    for (let i = 27; i < hrefs.length; i++) {
        let parseContent = '';
        let waitForUrls = [];
        let weiboes = '';
        const url = `https://d.weibo.com${hrefs[i]}`;
        const page = await createNewPage(url);
        // 滚动直到出现分页
        const scrollToPageBar = async() => {
            weiboes = await page.$$("div[action-type=feed_list_item]");
            let moreButton = null;
            let length = 0;
            while (length < 300) {
                moreButton = await page.$(".more_txt");
                while(!moreButton) {
                    await page.evaluate((scrollStep) => {
                        let scrollTop = document.scrollingElement.scrollTop;
                        document.scrollingElement.scrollTop = scrollStep + scrollTop;
                    }, 4000);
                    await sleep(2000);
                    moreButton = await page.$(".more_txt");
                }
                if (moreButton) {
                    await moreButton.click();
                    weiboes = await page.$$("div[action-type=feed_list_item]");
                    length = weiboes.length;
                }
                // if (moreButton) {
                //     await moreButton.click()
                // }
                // await page.evaluate((scrollStep) => {
                //     let scrollTop = document.scrollingElement.scrollTop;
                //     document.scrollingElement.scrollTop = scrollStep + scrollTop;
                // }, 1500);
                // await sleep(1500);
                // moreButton = await page.$(".more_txt");
                // weiboes = await page.$$("div[action-type=feed_list_item]");
                // if (weiboes.length === length) {
                //     length = 1000;
                // } else {
                //     length = weiboes.length;
                // }
            }
        }
        await scrollToPageBar();
        let wc = await Promise.all(weiboes.map(async(weibo, index) => {
            const weiboContent = await page.evaluate((weibo) => $.trim($(weibo).find("div[node-type=feed_list_content]").text()), weibo);
            const repostHref = await page.evaluate((weibo) => $(weibo).find(".WB_feed_expand  [node-type=feed_list_item_date]").attr("href"), weibo);
            if (repostHref) {
                logger.info(repostHref)
                waitForUrls.push(`https://weibo.com${repostHref}`);
            }
            let content;
            if (weiboContent.includes('展开全文')) {
                const href = await page.evaluate((weibo) => $(weibo).find("[node-type=feed_list_item_date]").attr("href"), weibo);
                waitForUrls.push(href);
                return {};
            } else {
                content = weiboContent;
            }
            return {
                content
            }
        }));
        for (const url of waitForUrls) {
            try {
                const newPage = await createNewPage(url);
                await newPage.waitForTimeout(1000);
                const content = await newPage.evaluate(() => document.querySelectorAll('div[node-type="feed_list_content"]')[0].innerText);
                logger.info('extra:', content)
                wc.push({
                    content
                });
                await newPage.close();
            } catch (e) {
                logger.warn('err:', e);
            }
        }
        for (const we of wc) {
            if (isNotUndef(we.content)) {
                parseContent += (we.content + '\n')
            }
        }
        // fs.writeFile(`./${names[i]}/file.txt`, parseContent, 'utf8', function(err) {
        //     if(err) {
        //         return console.log(err);
        //     }
        //     console.log(`${names[i]} was saved!`);
        // });
        fs.writeFileSync(`./${names[i]}/file.txt`, parseContent, 'utf8');
        await page.close();
    }
})()

